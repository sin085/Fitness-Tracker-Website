<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>sAIhat - Progress Tracker</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://unpkg.com/lucide@0.378.0/dist/umd/lucide.min.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0c0c0c; color: #f0f0f0; }
        .card { background-color: #212121; border-radius: 0.75rem; border: 1px solid #333; }
        .progress-circle-bg { fill: none; stroke: #333; stroke-width: 22; }
        .progress-circle-fg { fill: none; stroke: #e53e3e; stroke-width: 22; stroke-linecap: round; transition: stroke-dashoffset 1.5s ease-in-out; }
        .btn { display: inline-flex; align-items: center; justify-content: center; padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 500; transition: background-color 0.3s; }
        .btn-primary { background-color: #e53e3e; color: white; }
        .btn-primary:hover { background-color: #c53030; }
        .btn-secondary { background-color: #333; color: white; }
        .btn-secondary:hover { background-color: #444; }
        .modal-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); display: flex; justify-content: center; align-items: center; z-index: 50; }
        .modal-content { background-color: #212121; padding: 2rem; border-radius: 1rem; width: 90%; max-width: 500px; border: 1px solid #333; }
        .footer-bg { background-color: rgba(10, 10, 10, 0.8); backdrop-filter: blur(12px); border-top: 1px solid rgba(255, 45, 45, 0.3); }
        .website-name { font-weight: 800; font-size: 1.5rem; letter-spacing: -1px; color: #f0f0f0; }
        .website-name .ai-part { color: #e53e3e; font-style: italic; }
        .sidebar { position: fixed; top: 0; left: 0; height: 100%; width: 280px; background-color: #1a1a1a; border-right: 1px solid #333; transform: translateX(-100%); transition: transform 0.3s ease-out; z-index: 1000; padding: 1.5rem; display: flex; flex-direction: column; }
        .sidebar.open { transform: translateX(0); }
        .sidebar-backdrop { position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.7); opacity: 0; pointer-events: none; transition: opacity 0.3s ease; z-index: 999; }
        .sidebar-backdrop.open { opacity: 1; pointer-events: auto; }
        .footer-link.active { color: #e53e3e; text-shadow: 0 0 5px rgba(229, 62, 62, 0.8), 0 0 10px rgba(229, 62, 62, 0.6); }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-full mx-auto space-y-8 pb-28">
        <header class="flex justify-between items-center">
            <div class="flex items-center gap-3 cursor-pointer" id="user-console-trigger">
                <div class="w-10 h-10 bg-red-600 rounded-full flex items-center justify-center text-white font-bold text-lg">U</div>
                <div><p class="text-sm text-gray-400">Welcome Back!</p><p class="font-semibold text-white">User</p></div>
            </div>
            <h1 class="website-name">s<span class="ai-part">AI</span>hat</h1>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-1 space-y-8">
                <div class="card p-6 flex flex-col h-full">
                    <div class="flex justify-between items-start mb-4">
                        <h2 class="text-xl font-semibold">Goal Progress</h2>
                        <button id="editGoalBtn" class="btn btn-secondary btn-sm"><i data-lucide="pencil" class="w-4 h-4"></i></button>
                    </div>
                    <div class="flex-grow flex flex-col items-center justify-center py-4">
                        <div class="relative w-full" style="max-width: 220px;">
                            <svg class="w-full" viewBox="0 0 250 140">
                                <path class="progress-circle-bg" d="M 35 125 A 90 90 0 0 1 215 125" />
                                <path id="progress-bar" class="progress-circle-fg" d="M 35 125 A 90 90 0 0 1 215 125" stroke-dasharray="283" stroke-dashoffset="283" />
                            </svg>
                            <div class="absolute inset-0 flex flex-col items-center justify-end pb-4">
                                <span id="current-weight" class="text-3xl font-bold text-white">--kg</span>
                                <span class="text-gray-400 text-sm">Current</span>
                            </div>
                        </div>
                        <div class="flex justify-between w-full mt-2 px-4" style="max-width: 250px;">
                            <div class="text-center"><div id="start-weight" class="font-bold text-lg">--kg</div><div class="text-sm text-gray-400">Start</div></div>
                            <div class="text-center"><div id="goal-weight" class="font-bold text-lg">--kg</div><div class="text-sm text-gray-400">Goal</div></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="lg:col-span-2 space-y-8">
                <div class="card p-6">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4">
                        <h2 class="text-xl font-semibold mb-2 sm:mb-0">Weight History</h2>
                        <div class="flex space-x-2 bg-gray-700 p-1 rounded-md">
                            <button id="filter-week" class="filter-btn px-3 py-1 text-sm rounded-md transition">Week</button>
                            <button id="filter-month" class="filter-btn px-3 py-1 text-sm rounded-md transition bg-red-600">Month</button>
                            <button id="filter-year" class="filter-btn px-3 py-1 text-sm rounded-md transition">Year</button>
                        </div>
                    </div>
                    <div><canvas id="weightChart" height="300"></canvas></div>
                </div>
                <div class="card p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold">Photo History</h2>
                        <button id="compareBtn" class="btn btn-secondary"><i data-lucide="git-compare-arrows" class="w-4 h-4 mr-2"></i>Compare</button>
                    </div>
                    <div id="photo-gallery" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4"></div>
                </div>
                <div class="card p-6">
                    <h2 class="text-xl font-semibold mb-4">Daily Log</h2>
                    <div class="space-y-4">
                        <div>
                            <label for="weight-input" class="block text-sm font-medium text-gray-300 mb-1">Today's Weight (kg)</label>
                            <input type="number" id="weight-input" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-red-500" placeholder="Enter weight">
                        </div>
                        <div>
                            <label for="photo-upload" class="block text-sm font-medium text-gray-300 mb-1">Add Photo</label>
                            <input type="file" id="photo-upload" class="hidden" accept="image/*">
                            <button onclick="document.getElementById('photo-upload').click()" class="w-full btn btn-secondary"><i data-lucide="camera" class="w-4 h-4 mr-2"></i>Upload Photo</button>
                        </div>
                        <button id="addLogBtn" class="w-full btn btn-primary"><i data-lucide="plus-circle" class="w-4 h-4 mr-2"></i>Add Today's Log</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals and other static HTML elements -->
    <footer class="fixed bottom-0 left-0 right-0 footer-bg p-2 flex justify-around">
        <a href="Home.html" class="footer-link flex flex-col items-center justify-center text-slate-400 hover:text-red-500 w-1/4 py-1 transition-colors"><i data-lucide="home" class="w-6 h-6 mb-1"></i><span class="text-xs font-medium">Home</span></a>
        <a href="Progress.html" class="footer-link flex flex-col items-center justify-center text-slate-400 hover:text-red-500 w-1/4 py-1 transition-colors"><i data-lucide="bar-chart-3" class="w-6 h-6 mb-1"></i><span class="text-xs font-medium">Progress</span></a>
        <a href="Smart_Nutrition_Tracker.html" class="footer-link flex flex-col items-center justify-center text-slate-400 hover:text-red-500 w-1/4 py-1 transition-colors"><i data-lucide="carrot" class="w-6 h-6 mb-1"></i><span class="text-xs font-medium">Food</span></a>
        <a href="Workout_Tracker.html" class="footer-link flex flex-col items-center justify-center text-slate-400 hover:text-red-500 w-1/4 py-1 transition-colors"><i data-lucide="dumbbell" class="w-6 h-6 mb-1"></i><span class="text-xs font-medium">Workouts</span></a>
    </footer>
    <div id="editGoalModal" class="modal-backdrop hidden"><div class="modal-content"><h3 class="text-xl font-semibold mb-4">Edit Goal</h3><div class="space-y-4"><div><label for="start-weight-input" class="block text-sm font-medium text-gray-300 mb-1">Start Weight (kg)</label><input type="number" id="start-weight-input" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-red-500"></div><div><label for="goal-weight-input" class="block text-sm font-medium text-gray-300 mb-1">Goal Weight (kg)</label><input type="number" id="goal-weight-input" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-red-500"></div></div><div class="mt-6 flex justify-end space-x-4"><button id="cancelEditGoal" class="btn btn-secondary">Cancel</button><button id="saveGoal" class="btn btn-primary">Save</button></div></div></div>
    <div id="compareModal" class="modal-backdrop hidden"><div class="modal-content max-w-4xl"><div class="flex justify-between items-center mb-4"><h3 class="text-xl font-semibold">Compare Progress</h3><button id="closeCompareModal" class="text-gray-400 hover:text-white"><i data-lucide="x" class="w-6 h-6"></i></button></div><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div id="first-photo-container"><h4 class="font-semibold text-center mb-2">First Photo</h4><img id="first-photo" src="https://placehold.co/400x600/1a1a1a/f0f0f0?text=First\nPhoto" alt="First photo" class="w-full h-auto rounded-lg object-cover"><p id="first-photo-date" class="text-center text-gray-400 mt-2"></p></div><div id="latest-photo-container"><h4 class="font-semibold text-center mb-2">Latest Photo</h4><img id="latest-photo" src="https://placehold.co/400x600/e53e3e/ffffff?text=Latest\nPhoto" alt="Latest photo" class="w-full h-auto rounded-lg object-cover"><p id="latest-photo-date" class="text-center text-gray-400 mt-2"></p></div></div></div></div>
    <div id="user-sidebar" class="sidebar">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-xl font-bold">User Profile</h3>
            <button id="close-sidebar-button" class="text-slate-400 hover:text-white">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
        </div>
        <nav class="flex-grow">
            <ul>
                <li class="mb-4">
                    <a href="Home.html" class="footer-link flex items-center text-lg text-slate-300 hover:text-red-500 transition-colors">
                        <i data-lucide="layout-dashboard" class="w-5 h-5 mr-3"></i> Dashboard
                    </a>
                </li>
                <li class="mb-4">
                    <a href="Profile.html" id="profile-link" class="footer-link flex items-center text-lg text-slate-300 hover:text-red-500 transition-colors">
                        <i data-lucide="user" class="w-5 h-5 mr-3"></i> Profile
                    </a>
                </li>
                <li class="mb-4">
                    <a href="#" class="footer-link flex items-center text-lg text-slate-300 hover:text-red-500 transition-colors">
                        <i data-lucide="settings" class="w-5 h-5 mr-3"></i> Settings
                    </a>
                </li>
                <li>
                    <a href="#" class="footer-link flex items-center text-lg text-slate-300 hover:text-red-500 transition-colors">
                        <i data-lucide="shield" class="w-5 h-5 mr-3"></i> Privacy Notices
                    </a>
                </li>
            </ul>
        </nav>
        <div class="mt-auto pt-6 border-t border-gray-700">
            <button class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 rounded-lg transition-colors" onclick="window.location.href='Login.html'">
                Logout
            </button>
        </div>
    </div>
    <div id="sidebar-backdrop" class="sidebar-backdrop"></div>

    <script>
        // --- Configuration ---
        const API_URL = 'http://localhost:8081'; // Base URL for the backend
        let currentGoal = null;
        let weightChart = null;
        let allLogs = [];

        // --- Data Fetching ---
        async function fetchAllData() {
            await fetchGoalData();
            await fetchLogs();
        }

        async function fetchGoalData() {
            try {
                const response = await fetch(`${API_URL}/api/goals`);
                if (response.ok) {
                    currentGoal = await response.json();
                    updateGoalProgressUI(currentGoal);
                } else {
                    console.log("No goal found. Please create one.");
                    updateGoalProgressUI({ startWeight: 0, goalWeight: 0, currentWeight: 0 });
                }
            } catch (error) {
                console.error("Failed to fetch goal data:", error);
            }
        }

        async function fetchLogs() {
            try {
                const response = await fetch(`${API_URL}/api/logs`);
                if (response.ok) {
                    allLogs = await response.json();
                    updateChart('month');
                    updatePhotoGalleryUI();
                }
            } catch (error) {
                console.error("Failed to fetch logs:", error);
            }
        }

        // --- UI Update Functions ---
        function updateGoalProgressUI(goalData) {
            const { startWeight = 0, goalWeight = 0, currentWeight = 0 } = goalData;
            document.getElementById('current-weight').textContent = `${currentWeight}kg`;
            document.getElementById('start-weight').textContent = `${startWeight}kg`;
            document.getElementById('goal-weight').textContent = `${goalWeight}kg`;
            document.getElementById('start-weight-input').value = startWeight;
            document.getElementById('goal-weight-input').value = goalWeight;
            const totalSpan = Math.abs(startWeight - goalWeight);
            let progress = totalSpan === 0 ? 0 : (goalWeight < startWeight ? (startWeight - currentWeight) / totalSpan : (currentWeight - startWeight) / totalSpan);
            updateProgressBar(Math.max(0, Math.min(1, progress)));
        }

        function updateProgressBar(progressFraction) {
            const progressBar = document.getElementById('progress-bar');
            const circumference = 283;
            progressBar.style.strokeDashoffset = circumference * (1 - progressFraction);
        }
        
        function updatePhotoGalleryUI() {
            const gallery = document.getElementById('photo-gallery');
            gallery.innerHTML = '';
            const photoLogs = allLogs.filter(log => log.photoUrl);
            photoLogs.forEach(log => {
                const photoDate = new Date(log.logDate).toLocaleDateString();
                const imgContainer = document.createElement('div');
                imgContainer.className = 'relative group';
                const imageUrl = `${API_URL}${log.photoUrl}`;
                imgContainer.innerHTML = `<img src="${imageUrl}" alt="Progress on ${photoDate}" class="w-full h-24 object-cover rounded-md" onerror="this.src='https://placehold.co/400x600/212121/f0f0f0?text=Image+Error'"><div class="absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity"><span class="text-white text-sm font-bold">${photoDate}</span></div>`;
                gallery.appendChild(imgContainer);
            });
        }

        // --- Chart.js Logic ---
        function initializeChart() {
            const ctx = document.getElementById('weightChart').getContext('2d');
            weightChart = new Chart(ctx, {
                type: 'line',
                data: { datasets: [{ label: 'Weight (kg)', borderColor: '#e53e3e', backgroundColor: 'rgba(229, 62, 62, 0.1)', fill: true, tension: 0.3, pointBackgroundColor: '#fff', pointBorderColor: '#e53e3e', pointHoverRadius: 7, pointHoverBackgroundColor: '#e53e3e' }] },
                options: { responsive: true, maintainAspectRatio: false, scales: { x: { type: 'time', time: { unit: 'day', tooltipFormat: 'MMM dd, yyyy' }, grid: { color: 'rgba(255, 255, 255, 0.1)' }, ticks: { color: '#9ca3af' } }, y: { beginAtZero: false, grid: { color: 'rgba(255, 255, 255, 0.1)' }, ticks: { color: '#9ca3af', padding: 10 }, title: { display: true, text: 'Weight (kg)', color: '#9ca3af' } } }, plugins: { legend: { display: false }, tooltip: { backgroundColor: '#1a1a1a', titleColor: '#fff', bodyColor: '#fff', borderColor: '#333', borderWidth: 1 } } }
            });
        }

        function updateChart(filter) {
            if (!weightChart || !allLogs) return;
            const now = new Date();
            let startDate = new Date();
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('bg-red-600'));
            document.getElementById(`filter-${filter}`).classList.add('bg-red-600');
            if (filter === 'week') startDate.setDate(now.getDate() - 7);
            else if (filter === 'month') startDate.setMonth(now.getMonth() - 1);
            else if (filter === 'year') startDate.setFullYear(now.getFullYear() - 1);
            const filteredLogs = allLogs.filter(log => new Date(log.logDate) >= startDate);
            weightChart.data.labels = filteredLogs.map(log => new Date(log.logDate));
            weightChart.data.datasets[0].data = filteredLogs.map(log => ({ x: new Date(log.logDate), y: log.weight }));
            weightChart.update();
        }

        // --- Actions ---
        async function saveGoal() {
            const startWeight = parseFloat(document.getElementById('start-weight-input').value);
            const goalWeight = parseFloat(document.getElementById('goal-weight-input').value);
            if (isNaN(startWeight) || isNaN(goalWeight)) return alert("Please enter valid numbers for weights.");
            const goalPayload = { id: currentGoal ? currentGoal.id : null, startWeight, goalWeight, currentWeight: currentGoal ? currentGoal.currentWeight : startWeight };
            try {
                const response = await fetch(`${API_URL}/api/goals`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(goalPayload) });
                if (response.ok) {
                    currentGoal = await response.json();
                    updateGoalProgressUI(currentGoal);
                    document.getElementById('editGoalModal').classList.add('hidden');
                } else { alert("Failed to save goal."); }
            } catch (error) { console.error("Failed to save goal:", error); }
        }

        async function addLog() {
            const weightInput = document.getElementById('weight-input');
            const photoInput = document.getElementById('photo-upload');

            const weight = parseFloat(weightInput.value);
            if (isNaN(weight)) return alert("Please enter a valid weight.");

            const formData = new FormData();
            formData.append('weight', String(weight)); // Ensure weight is a string for FormData
            if (photoInput.files.length > 0) {
                formData.append('photo', photoInput.files[0]);
            }

            // --- DEBUGGING STEP ---
            console.log("Sending the following data to the backend:");
            for (let pair of formData.entries()) {
                console.log(pair[0] + ', ' + pair[1]);
            }
            // --- END DEBUGGING STEP ---

            try {
                const response = await fetch(`${API_URL}/api/logs`, {
                    method: 'POST',
                    body: formData
                });
                if (response.ok) {
                    await fetchAllData();
                    weightInput.value = '';
                    photoInput.value = '';
                } else { 
                    const errorText = await response.text();
                    console.error("Backend error:", errorText);
                    alert(`Failed to add log. Server responded with an error. Check the console (F12) for details.`);
                }
            } catch (error) { 
                console.error("Failed to add log due to a network error:", error); 
                alert("Could not connect to backend to add log.");
            }
        }
        
        function showCompareModal() {
            const photoLogs = allLogs.filter(log => log.photoUrl);
            if (photoLogs.length < 2) return alert("You need at least two photos to compare.");
            
            const firstLog = photoLogs[0];
            const latestLog = photoLogs[photoLogs.length - 1];
            
            document.getElementById('first-photo').src = `${API_URL}${firstLog.photoUrl}`;
            document.getElementById('first-photo-date').textContent = `Date: ${new Date(firstLog.logDate).toLocaleDateString()}`;
            
            document.getElementById('latest-photo').src = `${API_URL}${latestLog.photoUrl}`;
            document.getElementById('latest-photo-date').textContent = `Date: ${new Date(latestLog.logDate).toLocaleDateString()}`;
            
            document.getElementById('compareModal').classList.remove('hidden');
        }

        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            initializeChart();
            fetchAllData();

            // Modals and Buttons
            document.getElementById('editGoalBtn').addEventListener('click', () => document.getElementById('editGoalModal').classList.remove('hidden'));
            document.getElementById('cancelEditGoal').addEventListener('click', () => document.getElementById('editGoalModal').classList.add('hidden'));
            document.getElementById('saveGoal').addEventListener('click', saveGoal);
            document.getElementById('addLogBtn').addEventListener('click', addLog);
            document.getElementById('compareBtn').addEventListener('click', showCompareModal);
            document.getElementById('closeCompareModal').addEventListener('click', () => document.getElementById('compareModal').classList.add('hidden'));

            // Chart Filters
            ['week', 'month', 'year'].forEach(f => document.getElementById(`filter-${f}`).addEventListener('click', () => updateChart(f)));

            // Sidebar
            const userSidebar = document.getElementById('user-sidebar');
            const sidebarBackdrop = document.getElementById('sidebar-backdrop');
            document.getElementById('user-console-trigger').addEventListener('click', () => { userSidebar.classList.add('open'); sidebarBackdrop.classList.add('open'); });
            document.getElementById('close-sidebar-button').addEventListener('click', () => { userSidebar.classList.remove('open'); sidebarBackdrop.classList.remove('open'); });
            sidebarBackdrop.addEventListener('click', () => { userSidebar.classList.remove('open'); sidebarBackdrop.classList.remove('open'); });

            // Footer Active State
            const currentPath = window.location.pathname.split('/').pop() || 'Progress.html';
            document.querySelectorAll('.footer-link').forEach(link => { if (link.getAttribute('href') === currentPath) link.classList.add('active'); });
        });
    </script>
</body>
</html>
